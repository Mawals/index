<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª â€” Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø´Ø±Ù (Ø¬ÙˆØ§Ù„) v8</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxbM7zmeN1gW_ryUSVdTkI8XKkMFyICb2RYbjwBIzc5Hean6J35BI9efjODhvdlnw/exec';
</script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--green:#16a34a;--green-700:#15803d;--blue:#2563eb;--orange:#f59e0b;--red:#ef4444;--bg:#f3f6f9;--card:#fff;--border:#e5e7eb;--shadow:0 10px 24px rgba(0,0,0,.08)}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:#0f172a;font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .banner-wrap{position:sticky;top:0;z-index:5;padding:8px 12px;background:linear-gradient(180deg,#0000,#0001)} .banner{margin:auto;width:100%;max-width:720px;background:#e6f9ee;color:#0b3d22;border:1px solid #bbf7d0;border-radius:999px;text-align:center;padding:10px 14px;font-weight:800;box-shadow:var(--shadow)}
    .card{width:100%;max-width:720px;margin:12px auto;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .card-header{padding:12px 14px;background:#fafafa;border-bottom:1px solid var(--border)} .card-title{margin:0;color:#16a34a;font-size:20px;font-weight:800;text-align:center}
    form{padding:12px;display:grid;grid-template-columns:1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .label{font-weight:900;color:#0f172a;display:flex;align-items:center;gap:8px;justify-content:space-between} .label .left{display:flex;align-items:center;gap:8px}
    .badge{font-size:12px;font-weight:900;background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;border-radius:999px;padding:2px 10px}
    input,select,textarea{width:100%;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:18px;outline:none;transition:border .15s,box-shadow .15s;display:block}
    input:focus,select:focus,textarea:focus{border-color:#16a34a;box-shadow:0 0 0 4px rgba(34,197,94,.18)} textarea{min-height:120px;resize:vertical}
    .table-wrap{padding:6px 12px 12px;overflow:auto;max-width:100%} table{width:100%;border-collapse:collapse;min-width:640px} th,td{padding:10px;border-bottom:1px dashed var(--border);text-align:right} th{background:#fafafa;position:sticky;top:0}
    .actions-wrap{position:sticky;bottom:0;z-index:10;padding:8px 10px;background:#fff;border-top:1px solid var(--border);box-shadow:0 -6px 16px rgba(0,0,0,.06)}
    .actions{max-width:720px;margin:auto;display:grid;grid-template-columns:1fr;gap:6px}
    .btn{border:none;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;color:#fff;white-space:nowrap;box-shadow:var(--shadow);font-size:16px;line-height:1}
    .btn .icon{font-size:18px;line-height:1} .btn.send{background:var(--green)} .btn.send:active{background:var(--green-700)}
    .btn-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px} .btn.csv{background:var(--blue)} .btn.xlsx{background:var(--orange)} .btn.delete{background:var(--red)}
    .toast{position:fixed;inset-inline:0;top:12px;margin:auto;background:#16a34a;color:#fff;padding:10px 16px;border-radius:999px;width:max-content;max-width:90vw;box-shadow:var(--shadow);display:none;font-size:16px}
    .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
    .modal .box{background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px;width:min(92vw,420px)} .modal .box h3{margin:0 0 10px 0;text-align:center}
    .modal .row{display:flex;gap:8px;align-items:center;justify-content:center} .modal input{border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:18px;width:200px;text-align:center;letter-spacing:2px}
    .modal .action{border:none;border-radius:12px;padding:10px 14px;font-weight:900;color:#fff;background:#16a34a;cursor:pointer} .modal .cancel{background:#94a3b8}
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div class="banner-wrap"><div class="banner">Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ© Ù„Ù„Ø·Ù„Ø¨Ø©</div></div>

  <div class="card">
    <div class="card-header"><h2 class="card-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ© Ù„Ù„Ø·Ù„Ø¨Ø©</h2></div>
    <form id="dataForm">
      <div class="field"><div class="label"><span class="left">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</span></div><input id="studentName" name="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" required></div>
      <div class="field"><div class="label"><span class="left">ğŸ« Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</span><span class="badge">Ù…Ø·Ù„ÙˆØ¨</span></div>
        <select id="grade" name="Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ" required>
          <option value="">â€” Ø§Ø®ØªØ± â€”</option><option>Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„Ø³Ø§Ø¯Ø³</option><option>Ø§Ù„Ø³Ø§Ø¨Ø¹</option><option>Ø§Ù„Ø«Ø§Ù…Ù†</option><option>Ø§Ù„ØªØ§Ø³Ø¹</option><option>Ø§Ù„Ø¹Ø§Ø´Ø±</option><option>Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±</option><option>Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±</option>
        </select>
      </div>
      <div class="field"><div class="label"><span class="left">ğŸ”¢ Ø§Ù„Ø´Ø¹Ø¨Ø©</span><span class="badge">Ù…Ø·Ù„ÙˆØ¨</span></div>
        <select id="section" name="Ø§Ù„Ø´Ø¹Ø¨Ø©" required>
          <option value="">â€” Ø§Ø®ØªØ± â€”</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
        </select>
      </div>
      <div class="field"><div class="label"><span class="left">âš ï¸ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ©</span></div>
        <select id="violation" name="Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ©">
          <option value="">â€” Ø§Ø®ØªØ± â€”</option><option>Ø§Ù„Ù†ÙˆÙ… ÙÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØµ</option><option>Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø²ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ</option><option>Ø§Ù„Ø¥Ø³Ø§Ø¡Ø© Ø¨Ø§Ù„Ù‚ÙˆÙ„ Ø¥Ù„Ù‰ Ø£Ø­Ø¯ Ø²Ù…Ù„Ø§Ø¦Ù‡</option><option>Ø§Ù„Ø¥Ù‡Ù…Ø§Ù„ ÙÙŠ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</option><option>Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ø­ØµØ© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</option>
        </select>
      </div>
      <div class="field"><div class="label"><span class="left">ğŸ‘¨â€ğŸ« Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</span><span class="badge">Ù…Ø·Ù„ÙˆØ¨</span></div><input id="teacher" name="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…" required></div>
      <div class="field"><div class="label"><span class="left">ğŸ“˜ Ø§Ù„ØªØ®ØµØµ</span><span class="badge">Ù…Ø·Ù„ÙˆØ¨</span></div><input id="major" name="Ø§Ù„ØªØ®ØµØµ" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª / Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ©" required></div>
      <div class="field"><div class="label"><span class="left">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰</span></div><textarea id="notes" name="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea></div>
    </form>
    <div class="table-wrap"><table id="dataTable"><thead></thead><tbody></tbody></table></div>
  </div>

  <div class="actions-wrap">
    <div class="actions">
      <button class="btn send" id="sendBtn" type="submit" data-action="send"><span class="icon">ğŸ’¾</span> Ø­ÙØ¸/Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´Ø±Ù</button>
      <div class="btn-row">
        <button class="btn csv" id="exportCSV"><span class="icon">ğŸ“„</span> CSV</button>
        <button class="btn xlsx" id="exportXLSX"><span class="icon">ğŸ“Š</span> Excel</button>
        <button class="btn delete" id="clearAll"><span class="icon">ğŸ—‘ï¸</span> Ø­Ø°Ù</button>
      </div>
    </div>
  </div>

  <div class="modal" id="passModal" role="dialog" aria-modal="true" aria-labelledby="passTitle">
    <div class="box">
      <h3 id="passTitle">ğŸ” Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø±Ù</h3>
      <div class="row" style="margin-bottom:10px">
        <input type="password" id="adminCode" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric" pattern="\d*">
      </div>
      <div class="row">
        <button class="action" id="passOk">ØªØ£ÙƒÙŠØ¯</button>
        <button class="action cancel" id="passCancel">Ø¥Ù„ØºØ§Ø¡</button>
      
<script>
// === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxbM7zmeN1gW_ryUSVdTkI8XKkMFyICb2RYbjwBIzc5Hean6J35BI9efjODhvdlnw/exec';

// Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø©
const $=(s,c=document)=>c.querySelector(s);
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const STORAGE_KEY='customFormRecords.v1';
const ADMIN_CODE='1982';

function readForm(){
  const row={};
  $$('#dataForm [name]').forEach(el=>{ row[el.name]=el.value||''; });
  return row;
}

function clearAllFields(){
  try{ 
    const form = $('#dataForm');
    if(form && typeof form.reset==='function') form.reset();
    $$('#dataForm input, #dataForm select, #dataForm textarea').forEach(el=>{
      try{
        if(el.type==='checkbox'||el.type==='radio'){ el.checked=false; el.dispatchEvent(new Event('change',{bubbles:true})); }
        else if(el.tagName==='SELECT'){ el.selectedIndex=0; el.dispatchEvent(new Event('change',{bubbles:true})); }
        else { el.value=''; el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }
      }catch(_){}
    });
    $$('[data-display], .select-display, .selected-text, .current, .value-label').forEach(d=>{
      const ph=d.getAttribute('data-placeholder')||d.getAttribute('placeholder')||'Ø§Ø®ØªØ±...'; d.textContent=ph;
    });
    $$('.selected, .is-selected, .active').forEach(el=>el.classList.remove('selected','is-selected','active'));
    ($('#studentName')||$('#dataForm input, #dataForm select, #dataForm textarea'))?.focus();
  }catch(e){ console.warn('clearAllFields', e); }
}

function loadRecords(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch{return [];} }
function saveRecords(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
function renderTable(){
  const list=loadRecords(); const thead=$('#dataTable thead'); const tbody=$('#dataTable tbody');
  if(!list.length){ thead.innerHTML=''; tbody.innerHTML=''; return; }
  const cols=Object.keys(list[0]);
  thead.innerHTML='<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
  tbody.innerHTML=list.map(r=>'<tr>'+cols.map(c=>`<td>${(r[c]||'').toString().replace(/</g,'&lt;')}</td>`).join('')+'</tr>').join('');
}
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); }

function exportCSV(){
  const list=loadRecords(); if(!list.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
  const cols=Object.keys(list[0]); const esc=s=>'"'+String(s||'').replace(/"/g,'""')+'"';
  const lines=[cols.map(esc).join(',')]; for(const r of list) lines.push(cols.map(k=>esc(r[k])).join(','));
  const csv='\uFEFF'+lines.join('\n'); const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); a.download='records_'+Date.now()+'.csv'; a.click();
  toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù CSV');
}
function exportXLSX(){
  const list=loadRecords(); if(!list.length) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
  try{ const ws=XLSX.utils.json_to_sheet(list); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); XLSX.writeFile(wb,'records_'+Date.now()+'.xlsx'); toast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù Excel'); }
  catch(err){ console.error(err); alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel â€” Ø§Ø³ØªØ®Ø¯Ù… CSV'); }
}

let pendingAction=null;
function openPassModal(action){ pendingAction=action; $('#adminCode').value=''; $('#passModal').style.display='flex'; $('#adminCode').focus(); }
function closePassModal(){ $('#passModal').style.display='none'; }
function checkPassAndRun(){
  const code=($('#adminCode').value||'').trim();
  if(code!=='1982') return alert('Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­');
  if(pendingAction==='xlsx') exportXLSX();
  else if(pendingAction==='csv') exportCSV();
  else if(pendingAction==='clear'){ localStorage.removeItem(STORAGE_KEY); renderTable(); toast('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª'); }
  closePassModal(); pendingAction=null;
}

async function sendToSupervisor(){
  const formValues = readForm();
  const reqKeys = ['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨','Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ','Ø§Ù„Ø´Ø¹Ø¨Ø©','Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ','Ø§Ù„ØªØ®ØµØµ'];
  const missing = reqKeys.filter(k => !formValues[k]);
  if(missing.length) return alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: '+missing.join('ØŒ '));

  const now = new Date();
  const ts = new Intl.DateTimeFormat('ar-SA', {year:'numeric', month:'long', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:true}).format(now);
  const payload = {
    'Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ': ts,
    'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': formValues['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'],
    'Ø§Ù„ØµÙ': formValues['Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ'],
    'Ø§Ù„Ø´Ø¹Ø¨Ø©': formValues['Ø§Ù„Ø´Ø¹Ø¨Ø©'],
    'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©': formValues['Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ©']||'',
    'Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ': formValues['Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ'],
    'Ø§Ù„ØªØ®ØµØµ': formValues['Ø§Ù„ØªØ®ØµØµ'],
    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰': formValues['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰']||''
  };

  try{ const list=loadRecords(); list.push(payload); saveRecords(list); renderTable(); }catch(_){}

  let ok=false, msg='';
  try{
    const resp = await fetch(GAS_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
    const j = await resp.json().catch(()=>({}));
    ok = resp.ok && (j.status==='ok' || j.status==='success' || !Object.keys(j).length);
    msg = ok ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´Ø±Ù âœ…' : 'ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§';
  }catch(e){ console.error(e); msg='ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§'; }

  try{ (window.toast||alert)(msg); }catch(_){}
  if(ok){ try{ clearAllFields(); }catch(_){ } }
}

document.addEventListener('DOMContentLoaded', ()=>{
  $('#sendBtn')?.addEventListener('click', e=>{ e.preventDefault(); sendToSupervisor(); });
  $('#dataForm')?.addEventListener('submit', e=>{ e.preventDefault(); sendToSupervisor(); });
  $('#exportCSV')?.addEventListener('click', e=>{ e.preventDefault(); openPassModal('csv'); });
  $('#exportXLSX')?.addEventListener('click', e=>{ e.preventDefault(); openPassModal('xlsx'); });
  $('#clearAll')?.addEventListener('click', e=>{ e.preventDefault(); openPassModal('clear'); });
  $('#passOk')?.addEventListener('click', e=>{ e.preventDefault(); checkPassAndRun(); });
  $('#passCancel')?.addEventListener('click', e=>{ e.preventDefault(); pendingAction=null; closePassModal(); });
  renderTable();
});
</script>


<script>
if (typeof GAS_URL === 'undefined' || !GAS_URL) { window.GAS_URL = 'https://script.google.com/macros/s/AKfycbxbM7zmeN1gW_ryUSVdTkI8XKkMFyICb2RYbjwBIzc5Hean6J35BI9efjODhvdlnw/exec'; }
const $=(s,c=document)=>c.querySelector(s);
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));

function readFormLoose(){
  const row={};
  $$('#dataForm [name], [name]').forEach(el=>{
    const nm = el.getAttribute('name'); if(!nm) return;
    if(el.type==='checkbox') row[nm] = el.checked ? (el.value||'Ù†Ø¹Ù…') : '';
    else row[nm] = el.value||'';
  });
  return row;
}

function clearAllFieldsHard(){
  try{
    $$('form').forEach(f=>{ try{f.reset();}catch(_){}});
    $$('input, select, textarea').forEach(el=>{
      try{
        if(el.type==='checkbox'||el.type==='radio'){ if(el.checked){ el.checked=false; el.dispatchEvent(new Event('change',{bubbles:true})); } }
        else if(el.tagName==='SELECT'){ el.selectedIndex=0; el.dispatchEvent(new Event('change',{bubbles:true})); }
        else { el.value=''; el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); }
      }catch(_){}
    });
    $$('[data-display], .select-display, .selected-text, .current, .value-label').forEach(d=>{
      const ph=d.getAttribute('data-placeholder')||d.getAttribute('placeholder')||'Ø§Ø®ØªØ±...'; d.textContent=ph;
    });
    $$('.selected, .is-selected, .active').forEach(el=>el.classList.remove('selected','is-selected','active'));
    const first = document.getElementById('studentName') || $('input[type="text"], textarea, select');
    if(first) try{first.focus();}catch(_){}
  }catch(e){ console.warn('clearAllFieldsHard', e); }
}

function toast(msg){ try{const t=$('#toast'); if(t){t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',1500); return;} }catch(_){ } alert(msg); }

async function sendToSupervisor(){
  const v = readFormLoose();
  const need = ['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨','Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ','Ø§Ù„Ø´Ø¹Ø¨Ø©','Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ','Ø§Ù„ØªØ®ØµØµ'];
  const miss = need.filter(k => v[k]===undefined || v[k]==='');
  if(miss.length){ alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: '+miss.join('ØŒ ')); return; }

  const ts = new Intl.DateTimeFormat('ar-SA', {year:'numeric', month:'long', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:true}).format(new Date());
  const payload = {
    'Ø·Ø§Ø¨Ø¹ Ø²Ù…Ù†ÙŠ': ts,
    'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨': v['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨']||'',
    'Ø§Ù„ØµÙ': v['Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ']||'',
    'Ø§Ù„Ø´Ø¹Ø¨Ø©': v['Ø§Ù„Ø´Ø¹Ø¨Ø©']||'',
    'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©': v['Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ©']||'',
    'Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ': v['Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ']||'',
    'Ø§Ù„ØªØ®ØµØµ': v['Ø§Ù„ØªØ®ØµØµ']||'',
    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰': v['Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø£Ø®Ø±Ù‰']||''
  };

  let ok=false;
  try{
    const resp = await fetch(GAS_URL, {method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload)});
    if(resp.type==='opaque') ok=true;
    else { let j=null; try{ j=await resp.json(); }catch(_){ } ok = !!(resp.ok && j && (j.status==='ok' || j.status==='success')); }
  }catch(e){ console.error(e); ok=false; }

  toast(ok ? 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´Ø±Ù âœ…' : 'ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§');
  if(ok) clearAllFieldsHard();
}

document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('sendBtn') || document.querySelector('[data-action="send"]');
  if(btn) btn.addEventListener('click', function(e){ e.preventDefault(); sendToSupervisor(); });
  document.querySelectorAll('form').forEach(f=>{
    f.addEventListener('submit', function(e){ e.preventDefault(); sendToSupervisor(); });
  });
});
</script>

</body>
</html>
